<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - PCåˆå¿ƒè€…ç”¨ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ </title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="logo"></div>
        <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <button class="hamburger-menu" onclick="toggleSidebar()">
            <span>â˜°</span>
        </button>
        <div class="user-info">
            <span class="user-name" id="userName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
            <button class="logout-btn" onclick="authSystem.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="chapter-layout">
        <nav class="chapter-sidebar" id="chapterSidebar">
            <div class="sidebar-header">
                <h3>PCåˆå¿ƒè€…ç”¨ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ </h3>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <span>â‰¡</span>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </nav>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="chapter-main">
            <!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ -->
            <nav class="breadcrumb">
                <a href="home.html">ãƒ›ãƒ¼ãƒ </a>
                <span class="breadcrumb-separator">></span>
                <a href="pc-beginner.html">PCåˆå¿ƒè€…ç”¨ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ </a>
                <span class="breadcrumb-separator">></span>
                <span class="breadcrumb-current" id="currentChapterBreadcrumb">ãƒãƒ£ãƒ—ã‚¿ãƒ¼</span>
            </nav>

            <!-- ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="chapter-header">
                <div class="chapter-meta">
                    <span class="lesson-badge" id="lessonBadge">STEP 1</span>
                </div>
                <h1 class="chapter-title" id="chapterTitle">ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«</h1>
            </div>

            <!-- ãƒãƒ£ãƒ—ã‚¿ãƒ¼å†…å®¹ -->
            <div class="chapter-content">
                <div class="content-card">
                    <div id="dynamicContent">
                        <!-- å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        <div class="loading-message">
                            <p>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé€²æ—ç®¡ç†ãªã—ï¼‰ -->
                <div class="chapter-navigation">
                    <div class="nav-buttons">
                        <button class="nav-button prev" id="prevButton" onclick="navigateToPrevious()">
                            â† å‰ã®STEP
                        </button>
                        <button class="nav-button back-to-curriculum" onclick="backToCurriculum()">
                            ğŸ“‹ ã‚³ãƒ¼ã‚¹ä¸€è¦§ã«æˆ»ã‚‹
                        </button>
                        <button class="nav-button next" id="nextButton" onclick="navigateToNext()">
                            æ¬¡ã®STEP â†’
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/hybrid-progress.js"></script>
    <script>
        let currentStepId = '';
        let currentStepTitle = '';

        document.addEventListener('DOMContentLoaded', function() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (!authSystem.requireAuth()) {
                return;
            }

            // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            currentStepId = urlParams.get('step');
            currentStepTitle = urlParams.get('title');

            if (!currentStepId) {
                window.location.href = 'pc-beginner.html';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¡¨ç¤º
            displayUserInfo();

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ç”Ÿæˆ
            generateSidebar();

            // ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã®è¡¨ç¤º
            displayStepInfo();

            // å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿
            loadStepContent();

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®è¨­å®š
            setupNavigation();
        });

        function loadStepContent() {
            // å­¦ç¿’ç›®æ¨™ã¯å„STEPã®æœ€åˆã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ï¼ˆchapter1ï¼‰ã«é…ç½®ã•ã‚Œã‚‹
            const contentPath = `content/pc-${currentStepId}-chapter1.html`;

            fetch(contentPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(htmlContent => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    let contentNode = doc.querySelector('.page-body');

                    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                    if (!contentNode) {
                        contentNode = doc.querySelector('article');
                    }
                    if (!contentNode) {
                        contentNode = doc.body;
                    }

                    const dynamicContent = document.getElementById('dynamicContent');
                    dynamicContent.innerHTML = ''; // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢

                    if (contentNode) {
                        // innerHTMLã‚’ä½¿ã‚ãšã€DOMãƒãƒ¼ãƒ‰ã¨ã—ã¦å®‰å…¨ã«è¿½åŠ ã™ã‚‹
                        while (contentNode.firstChild) {
                            dynamicContent.appendChild(contentNode.firstChild);
                        }

                        // Google Slidesã®URLã‚’iframeã«å¤‰æ›
                        convertGoogleSlidesToEmbed();
                    } else {
                        throw new Error("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«è¡¨ç¤ºå¯èƒ½ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    }
                })
                .catch(error => {
                    console.error('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    document.getElementById('dynamicContent').innerHTML = `
                        <div class="error-message">
                            <h3>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                            <p>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: ${contentPath}</p>
                            <p>ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}</p>
                            <p>Notionã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                });
        }

        function convertGoogleSlidesToEmbed() {
            // .source ã‚¯ãƒ©ã‚¹ã®è¦ç´ ã‚’æ¢ã™ï¼ˆNotion ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®Google Slidesãƒªãƒ³ã‚¯ï¼‰
            const sourceElements = document.querySelectorAll('.source');

            sourceElements.forEach(sourceEl => {
                const url = sourceEl.textContent.trim();

                // Google Slides URLã‹ãƒã‚§ãƒƒã‚¯
                if (url.includes('docs.google.com/presentation')) {
                    // URLã‹ã‚‰ presentation ID ã‚’æŠ½å‡º
                    const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);

                    if (match && match[1]) {
                        const presentationId = match[1];
                        const embedUrl = `https://docs.google.com/presentation/d/${presentationId}/embed?start=false&loop=false&delayms=3000`;

                        // iframeã‚’ä½œæˆ
                        const iframe = document.createElement('iframe');
                        iframe.src = embedUrl;
                        iframe.width = '100%';
                        iframe.height = '569';
                        iframe.frameBorder = '0';
                        iframe.allowFullscreen = true;
                        iframe.style.border = '1px solid #e1e8ed';
                        iframe.style.borderRadius = '8px';
                        iframe.style.marginTop = '1rem';

                        // è¦ªè¦ç´ ï¼ˆfigureï¼‰ã‚’ç½®ãæ›ãˆ
                        const figure = sourceEl.closest('figure');
                        if (figure) {
                            figure.parentNode.replaceChild(iframe, figure);
                        }
                    }
                }
            });

            // Notionãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ï¼ˆ.link-to-pageï¼‰ã‚’å‰Šé™¤
            const linkToPageElements = document.querySelectorAll('.link-to-page');
            linkToPageElements.forEach(link => {
                link.remove();
            });
        }

        function displayUserInfo() {
            const currentUser = authSystem.getCurrentUser();
            if (currentUser) {
                const userNameEl = document.getElementById('userName');
                if (userNameEl) {
                    userNameEl.textContent = currentUser.name;
                }
            }
        }

        function displayStepInfo() {
            document.getElementById('lessonBadge').textContent = `STEP ${currentStepId.replace('step', '')}`;
            document.getElementById('chapterTitle').textContent = decodeURIComponent(currentStepTitle);
            document.getElementById('currentChapterBreadcrumb').textContent = decodeURIComponent(currentStepTitle);
        }

        function generateSidebar() {
            const curriculum = progressManager.getCurriculumData().pc_beginner;
            if (!curriculum) return;

            const sidebarContent = document.querySelector('.sidebar-content');
            let html = '<ul class="chapters-sidebar">';

            curriculum.steps.forEach((step, index) => {
                const stepNumber = index + 1;
                const isCurrentStep = step.id === currentStepId;

                html += `
                    <li class="chapter-sidebar-item ${isCurrentStep ? 'current' : ''}">
                        <a href="pc-beginner-chapter.html?step=${step.id}&title=${encodeURIComponent(step.title)}"
                           class="chapter-link">
                            <span class="chapter-number">${stepNumber}</span>
                            <span class="chapter-title-sidebar">${step.title}</span>
                        </a>
                    </li>
                `;
            });

            html += '</ul>';
            sidebarContent.innerHTML = html;
        }

        function setupNavigation() {
            const curriculum = progressManager.getCurriculumData().pc_beginner;
            if (!curriculum) return;

            const currentIndex = curriculum.steps.findIndex(step => step.id === currentStepId);

            // å‰ã¸ãƒœã‚¿ãƒ³
            const prevButton = document.getElementById('prevButton');
            if (currentIndex > 0) {
                const prevStep = curriculum.steps[currentIndex - 1];
                prevButton.onclick = () => {
                    window.location.href = `pc-beginner-chapter.html?step=${prevStep.id}&title=${encodeURIComponent(prevStep.title)}`;
                };
            } else {
                prevButton.disabled = true;
                prevButton.style.opacity = '0.5';
            }

            // æ¬¡ã¸ãƒœã‚¿ãƒ³
            const nextButton = document.getElementById('nextButton');
            if (currentIndex < curriculum.steps.length - 1) {
                const nextStep = curriculum.steps[currentIndex + 1];
                nextButton.onclick = () => {
                    window.location.href = `pc-beginner-chapter.html?step=${nextStep.id}&title=${encodeURIComponent(nextStep.title)}`;
                };
            } else {
                nextButton.disabled = true;
                nextButton.style.opacity = '0.5';
            }
        }

        function navigateToPrevious() {
            // setupNavigation() ã§è¨­å®šæ¸ˆã¿
        }

        function navigateToNext() {
            // setupNavigation() ã§è¨­å®šæ¸ˆã¿
        }

        function backToCurriculum() {
            window.location.href = 'pc-beginner.html';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('chapterSidebar');
            sidebar.classList.toggle('collapsed');
        }
    </script>
</body>
</html>
