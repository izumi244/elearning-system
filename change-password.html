<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パスワード変更 - 学習管理システム</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="login-page">
    <div class="logo-section">
        <h1></h1>
    </div>

    <div class="login-container">
        <div class="login-card">
            <div class="system-title">
                <h2>初回ログイン</h2>
                <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">セキュリティのため、パスワードを変更してください</p>
            </div>

            <form id="changePasswordForm" class="login-form">
                <div class="input-group">
                    <label for="newPassword">新しいパスワード</label>
                    <input
                        type="password"
                        id="newPassword"
                        name="newPassword"
                        placeholder="新しいパスワードを入力"
                        required
                        minlength="6"
                        autocomplete="new-password"
                    >
                </div>

                <div class="input-group">
                    <label for="confirmPassword">パスワード確認</label>
                    <input
                        type="password"
                        id="confirmPassword"
                        name="confirmPassword"
                        placeholder="もう一度入力してください"
                        required
                        minlength="6"
                        autocomplete="new-password"
                    >
                </div>

                <button type="submit" class="login-button">
                    <span>パスワードを変更</span>
                </button>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="successMessage" class="success-message" style="display: none;"></div>
            </form>

            <div class="login-help">
                <small>
                    <strong>パスワードのルール:</strong><br>
                    • 小文字英字3文字以上<br>
                    • 数字3文字以上<br>
                    例: abc123, test456
                </small>
            </div>
        </div>
    </div>

    <!-- JavaScriptファイル -->
    <script src="js/config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 認証チェック - ログインしていない場合はログインページへ
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            // フォーム送信処理
            const form = document.getElementById('changePasswordForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleChangePassword();
            });
        });

        async function handleChangePassword() {
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            // バリデーション
            if (!newPassword || !confirmPassword) {
                showError('すべての項目を入力してください。');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('パスワードが一致しません。');
                return;
            }

            // パスワードのバリデーション: 小文字英字3文字以上 + 数字3文字以上
            const lowercaseCount = (newPassword.match(/[a-z]/g) || []).length;
            const digitCount = (newPassword.match(/[0-9]/g) || []).length;

            if (lowercaseCount < 3 || digitCount < 3) {
                showError('パスワードは小文字英字3文字以上、数字3文字以上を含めてください。');
                return;
            }

            // Apps Script経由でパスワード変更
            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'changePassword',
                        userId: currentUser.userId,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // パスワード変更成功
                    showSuccess('パスワードを変更しました。ホーム画面に移動します...');

                    // isFirstLoginをfalseに更新
                    currentUser.isFirstLogin = false;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    // 2秒後にリダイレクト
                    setTimeout(() => {
                        if (currentUser.role === 'admin') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'home.html';
                        }
                    }, 2000);
                } else {
                    showError(result.error || 'パスワード変更に失敗しました。');
                }
            } catch (error) {
                console.error('パスワード変更エラー:', error);
                showError('パスワード変更中にエラーが発生しました。');
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            successMessage.style.display = 'none';
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';

            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            errorMessage.style.display = 'none';
            successMessage.textContent = message;
            successMessage.style.display = 'block';
        }
    </script>
</body>
</html>
