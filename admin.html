<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ç®¡ç†è€…ç”»é¢</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin-styles.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="logo"></div>
        <div class="user-info">
            <span class="user-name" id="userName">ç®¡ç†è€…</span>
            <button class="logout-btn" onclick="authSystem.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="admin-container">
            <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« -->
            <div class="page-header">
                <h1 class="page-title">ç®¡ç†è€…ç”»é¢</h1>
                <p class="page-description">å—è¬›è€…ã®å­¦ç¿’é€²æ—ã¨ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨çŠ¶æ³ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p>
            </div>

            <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-content">
                            <h3>ç·å—è¬›è€…æ•°</h3>
                            <div class="stat-number" id="totalUsers">30</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“š</div>
                        <div class="stat-content">
                            <h3>å­¦ç¿’ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                            <div class="stat-number" id="activeUsers">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-content">
                            <h3>å®Œäº†ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                            <div class="stat-number" id="completedUsers">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“Š</div>
                        <div class="stat-content">
                            <h3>å¹³å‡é€²æ—ç‡</h3>
                            <div class="stat-number" id="averageProgress">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="admin-tabs">
                <button class="tab-button active" onclick="switchTab('progress')">é€²æ—ç®¡ç†</button>
            </div>

            <!-- é€²æ—ç®¡ç†ã‚¿ãƒ– -->
            <div class="tab-content active" id="progressTab">
                <div class="section-header">
                    <h2>å—è¬›è€…é€²æ—ä¸€è¦§</h2>
                    <div class="controls">
                        <select id="progressFilter" onchange="filterProgress()">
                            <option value="all">ã™ã¹ã¦</option>
                            <option value="not-started">æœªé–‹å§‹</option>
                            <option value="in-progress">å­¦ç¿’ä¸­</option>
                            <option value="completed">å®Œäº†</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshProgress()">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>

                <div class="progress-table-container">
                    <table class="admin-table" id="progressTable">
                        <thead>
                            <tr>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>é€²æ—ç‡</th>
                                <th>å®Œäº†ãƒãƒ£ãƒ—ã‚¿ãƒ¼</th>
                                <th>æœ€çµ‚æ›´æ–°</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å—è¬›è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div class="modal" id="userDetailModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalUserName">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h3>
                        <button class="modal-close" onclick="closeUserModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="user-detail-grid">
                            <div class="detail-section">
                                <h4>åŸºæœ¬æƒ…å ±</h4>
                                <div class="detail-item">
                                    <span class="label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</span>
                                    <span class="value" id="modalUserId">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">é€²æ—ç‡:</span>
                                    <span class="value" id="modalProgress">-</span>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h4>å®Œäº†ãƒãƒ£ãƒ—ã‚¿ãƒ¼</h4>
                                <div class="completed-chapters" id="modalCompletedChapters">
                                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeUserModal()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/hybrid-progress.js"></script>
    <script>
        let allProgressData = [];

        document.addEventListener('DOMContentLoaded', function() {
            // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
            if (!authSystem.requireAdmin()) {
                return;
            }

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const currentUser = authSystem.getCurrentUser();
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || 'ç®¡ç†è€…';
            }

            // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸèª­ã¿è¾¼ã¿
            loadAdminData();

            // çµ±è¨ˆã®è¡¨ç¤º
            updateStatistics();
        });

        async function loadAdminData() {
            try {
                // Google Sheetsã‹ã‚‰é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                console.log('ğŸ“Š Google Sheetsã‹ã‚‰é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                const sheetsData = await hybridProgressManager.fetchFromGoogleSheetsAPI();

                // Usersã‚·ãƒ¼ãƒˆã‹ã‚‰roleæƒ…å ±ã‚’å–å¾—
                const usersUrl = `${CONFIG.GOOGLE_SHEETS_API_BASE_URL}/${CONFIG.SPREADSHEET_ID}/values/Users!A:E?key=${CONFIG.GOOGLE_API_KEY}`;
                const usersResponse = await fetch(usersUrl);
                const usersData = await usersResponse.json();

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã®ãƒãƒƒãƒ—ã‚’ä½œæˆï¼ˆuserId -> roleï¼‰
                const userRoles = {};
                if (usersData && usersData.values && usersData.values.length > 1) {
                    usersData.values.slice(1).forEach(row => {
                        const userId = row[0];
                        const role = row[2]; // Cåˆ—ãŒrole
                        if (userId) {
                            userRoles[userId] = role;
                        }
                    });
                }

                if (sheetsData && sheetsData.values && sheetsData.values.length > 1) {
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å¤‰æ›
                    allProgressData = sheetsData.values.slice(1).map(row => {
                        return {
                            userId: row[0] || '',
                            userName: row[1] || '',
                            totalChapters: parseInt(row[2]) || 34,
                            completedChapters: [],
                            completionRate: parseInt(row[4]) || 0,
                            lastUpdated: row[5] || '',
                            completedChaptersList: row[6] || ''
                        };
                    }).filter(user => {
                        // ç©ºè¡Œã‚’é™¤å¤–ã€ã‹ã¤ç®¡ç†è€…(admin)ã‚’é™¤å¤–
                        return user.userId && userRoles[user.userId] !== 'admin';
                    });

                    console.log(`âœ… ${allProgressData.length}ä»¶ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆç®¡ç†è€…é™¤å¤–ï¼‰`);
                } else {
                    console.log('âš ï¸  é€²æ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    allProgressData = [];
                }

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
                updateProgressTable();
                updateStatistics();

            } catch (error) {
                console.error('âŒ Google Sheetsã‹ã‚‰ã®åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                alert('é€²æ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                allProgressData = [];
            }
        }

        function updateStatistics() {
            // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç·å—è¬›è€…æ•°ã‚’è¨ˆç®—
            const totalUsers = allProgressData.length;
            let activeUsers = 0;
            let completedUsers = 0;
            let notStartedUsers = 0;
            let totalProgress = 0;

            allProgressData.forEach(user => {
                const rate = parseInt(user.completionRate) || 0;

                if (rate === 0) {
                    notStartedUsers++;
                } else if (rate === 100) {
                    completedUsers++;
                } else {
                    activeUsers++;
                }

                totalProgress += rate;
            });

            const averageProgress = totalUsers > 0 ?
                Math.round(totalProgress / totalUsers) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('completedUsers').textContent = completedUsers;
            document.getElementById('averageProgress').textContent = averageProgress + '%';
        }

        function updateProgressTable() {
            const tableBody = document.getElementById('progressTableBody');
            const filter = document.getElementById('progressFilter').value;

            let filteredData = allProgressData.filter(user => {
                if (filter === 'all') return true;
                if (filter === 'not-started') return user.completionRate === 0;
                if (filter === 'in-progress') return user.completionRate > 0 && user.completionRate < 100;
                if (filter === 'completed') return user.completionRate === 100;
                return true;
            });

            let html = '';
            filteredData.forEach(user => {
                // completedChaptersListã¯ "lesson1_1,lesson1_2" ã®ã‚ˆã†ãªæ–‡å­—åˆ—
                const completedCount = user.completedChaptersList && user.completedChaptersList.trim() !== '' ?
                    user.completedChaptersList.split(',').filter(c => c.trim() !== '').length : 0;
                const lastUpdated = user.lastUpdated ?
                    new Date(user.lastUpdated).toLocaleDateString('ja-JP') : 'æœªå­¦ç¿’';
                
                let status = 'æœªé–‹å§‹';
                let statusClass = 'not-started';
                
                if (user.completionRate === 100) {
                    status = 'å®Œäº†';
                    statusClass = 'completed';
                } else if (user.completionRate > 0) {
                    status = 'å­¦ç¿’ä¸­';
                    statusClass = 'in-progress';
                }

                html += `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.userName}</td>
                        <td>
                            <div class="progress-cell">
                                <div class="progress-bar small">
                                    <div class="progress-fill" style="width: ${user.completionRate}%"></div>
                                </div>
                                <span>${user.completionRate}%</span>
                            </div>
                        </td>
                        <td>${completedCount} / ${user.totalChapters}</td>
                        <td>${lastUpdated}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-small" onclick="showUserDetail('${user.userId}')">
                                è©³ç´°
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html || '<tr><td colspan="7" class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        }


        function showUserDetail(userId) {
            const user = allProgressData.find(u => u.userId === userId);
            if (!user) return;

            document.getElementById('modalUserName').textContent = `${user.userName}ã®è©³ç´°æƒ…å ±`;
            document.getElementById('modalUserId').textContent = user.userId;
            document.getElementById('modalProgress').textContent = user.completionRate + '%';

            // å®Œäº†ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã®è¡¨ç¤º
            let completedChaptersHtml = '';
            if (user.completedChaptersList && user.completedChaptersList.trim() !== '') {
                const chapters = user.completedChaptersList.split(',').filter(c => c.trim() !== '');
                completedChaptersHtml = chapters.map(chapterId => `
                    <div class="completed-chapter-item">
                        <span class="chapter-title">${chapterId}</span>
                    </div>
                `).join('');
            } else {
                completedChaptersHtml = '<div class="no-data">å®Œäº†ã—ãŸãƒãƒ£ãƒ—ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            }

            document.getElementById('modalCompletedChapters').innerHTML = completedChaptersHtml;
            
            document.getElementById('userDetailModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userDetailModal').style.display = 'none';
        }

        function switchTab(tabName) {
            // ã‚¿ãƒ–ãŒ1ã¤ã—ã‹ãªã„ã®ã§ä½•ã‚‚ã—ãªã„ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚é–¢æ•°ã¯æ®‹ã™ï¼‰
        }

        function filterProgress() {
            updateProgressTable();
        }

        function refreshProgress() {
            loadAdminData();
            updateStatistics();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('userDetailModal');
            if (event.target === modal) {
                closeUserModal();
            }
        }
    </script>
</body>
</html>