<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ç®¡ç†è€…ç”»é¢</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin-styles.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="logo">ã€ãƒ­ã‚´ã€‘</div>
        <div class="user-info">
            <div class="user-avatar admin">A</div>
            <span class="user-name">ç®¡ç†è€…</span>
            <button class="logout-btn" onclick="authSystem.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="admin-container">
            <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« -->
            <div class="page-header">
                <h1 class="page-title">ç®¡ç†è€…ç”»é¢</h1>
                <p class="page-description">å—è¬›è€…ã®å­¦ç¿’é€²æ—ã¨ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨çŠ¶æ³ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p>
            </div>

            <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-content">
                            <h3>ç·å—è¬›è€…æ•°</h3>
                            <div class="stat-number" id="totalUsers">30</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“š</div>
                        <div class="stat-content">
                            <h3>å­¦ç¿’ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                            <div class="stat-number" id="activeUsers">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-content">
                            <h3>å®Œäº†ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                            <div class="stat-number" id="completedUsers">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“Š</div>
                        <div class="stat-content">
                            <h3>å¹³å‡é€²æ—ç‡</h3>
                            <div class="stat-number" id="averageProgress">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="admin-tabs">
                <button class="tab-button active" onclick="switchTab('progress')">é€²æ—ç®¡ç†</button>
                <button class="tab-button" onclick="switchTab('login-history')">ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´</button>
                <button class="tab-button" onclick="switchTab('export')">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>

            <!-- é€²æ—ç®¡ç†ã‚¿ãƒ– -->
            <div class="tab-content active" id="progressTab">
                <div class="section-header">
                    <h2>å—è¬›è€…é€²æ—ä¸€è¦§</h2>
                    <div class="controls">
                        <select id="progressFilter" onchange="filterProgress()">
                            <option value="all">ã™ã¹ã¦</option>
                            <option value="not-started">æœªé–‹å§‹</option>
                            <option value="in-progress">å­¦ç¿’ä¸­</option>
                            <option value="completed">å®Œäº†</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshProgress()">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>

                <div class="progress-table-container">
                    <table class="admin-table" id="progressTable">
                        <thead>
                            <tr>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>é€²æ—ç‡</th>
                                <th>å®Œäº†ãƒãƒ£ãƒ—ã‚¿ãƒ¼</th>
                                <th>æœ€çµ‚æ›´æ–°</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã‚¿ãƒ– -->
            <div class="tab-content" id="loginHistoryTab">
                <div class="section-header">
                    <h2>ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´</h2>
                    <div class="controls">
                        <select id="historyFilter" onchange="filterHistory()">
                            <option value="all">ã™ã¹ã¦</option>
                            <option value="today">æœ¬æ—¥</option>
                            <option value="week">1é€±é–“</option>
                            <option value="month">1ãƒ¶æœˆ</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshHistory()">ğŸ”„ æ›´æ–°</button>
                    </div>
                </div>

                <div class="history-table-container">
                    <table class="admin-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚</th>
                                <th>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ—¥æ™‚</th>
                                <th>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
            <div class="tab-content" id="exportTab">
                <div class="section-header">
                    <h2>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
                </div>

                <div class="export-section">
                    <div class="export-cards">
                        <div class="export-card">
                            <div class="export-icon">ğŸ“Š</div>
                            <h3>é€²æ—ãƒ‡ãƒ¼ã‚¿</h3>
                            <p>å…¨å—è¬›è€…ã®å­¦ç¿’é€²æ—ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
                            <button class="btn btn-primary" onclick="exportProgressCSV()">
                                ğŸ“¥ é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>

                        <div class="export-card">
                            <div class="export-icon">ğŸ“‹</div>
                            <h3>ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´</h3>
                            <p>å—è¬›è€…ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå±¥æ­´ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
                            <button class="btn btn-primary" onclick="exportHistoryCSV()">
                                ğŸ“¥ å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>

                        <div class="export-card">
                            <div class="export-icon">ğŸ“ˆ</div>
                            <h3>çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ</h3>
                            <p>å­¦ç¿’çŠ¶æ³ã®çµ±è¨ˆæƒ…å ±ã‚’ã¾ã¨ã‚ãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                            <button class="btn btn-primary" onclick="exportStatisticsReport()">
                                ğŸ“¥ çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>

                    <div class="export-options">
                        <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                        <div class="options-grid">
                            <label class="option-item">
                                <input type="checkbox" id="includePersonalInfo" checked>
                                <span>å€‹äººæƒ…å ±ã‚’å«ã‚€</span>
                            </label>
                            <label class="option-item">
                                <input type="checkbox" id="includeTimestamps" checked>
                                <span>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å«ã‚€</span>
                            </label>
                            <label class="option-item">
                                <input type="checkbox" id="includeProgressDetails" checked>
                                <span>è©³ç´°ãªé€²æ—æƒ…å ±ã‚’å«ã‚€</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å—è¬›è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div class="modal" id="userDetailModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalUserName">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h3>
                        <button class="modal-close" onclick="closeUserModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="user-detail-grid">
                            <div class="detail-section">
                                <h4>åŸºæœ¬æƒ…å ±</h4>
                                <div class="detail-item">
                                    <span class="label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</span>
                                    <span class="value" id="modalUserId">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">é€²æ—ç‡:</span>
                                    <span class="value" id="modalProgress">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³:</span>
                                    <span class="value" id="modalLastLogin">-</span>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h4>å®Œäº†ãƒãƒ£ãƒ—ã‚¿ãƒ¼</h4>
                                <div class="completed-chapters" id="modalCompletedChapters">
                                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeUserModal()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/hybrid-progress.js"></script>
    <script>
        let allProgressData = [];
        let allLoginHistory = [];

        document.addEventListener('DOMContentLoaded', function() {
            // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
            if (!authSystem.requireAdmin()) {
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸèª­ã¿è¾¼ã¿
            loadAdminData();
            
            // çµ±è¨ˆã®è¡¨ç¤º
            updateStatistics();
        });

        async function loadAdminData() {
            try {
                // Google Sheetsã‹ã‚‰é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                console.log('ğŸ“Š Google Sheetsã‹ã‚‰é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                const sheetsData = await hybridProgressManager.fetchFromGoogleSheetsAPI();

                if (sheetsData && sheetsData.values && sheetsData.values.length > 1) {
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å¤‰æ›
                    allProgressData = sheetsData.values.slice(1).map(row => {
                        return {
                            userId: row[0] || '',
                            userName: row[1] || '',
                            totalChapters: parseInt(row[2]) || 34,
                            completedChapters: [],
                            completionRate: parseInt(row[4]) || 0,
                            lastUpdated: row[5] || '',
                            completedChaptersList: row[6] || ''
                        };
                    }).filter(user => user.userId); // ç©ºè¡Œã‚’é™¤å¤–

                    console.log(`âœ… ${allProgressData.length}ä»¶ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                } else {
                    console.log('âš ï¸  é€²æ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    allProgressData = [];
                }

                // ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã®å–å¾—
                allLoginHistory = JSON.parse(localStorage.getItem('loginHistory') || '[]');

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
                updateProgressTable();
                updateHistoryTable();
                updateStatistics();

            } catch (error) {
                console.error('âŒ Google Sheetsã‹ã‚‰ã®åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                alert('é€²æ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                allProgressData = [];
            }
        }

        function updateStatistics() {
            // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç·å—è¬›è€…æ•°ã‚’è¨ˆç®—
            const totalUsers = allProgressData.length;
            let activeUsers = 0;
            let completedUsers = 0;
            let notStartedUsers = 0;
            let totalProgress = 0;

            allProgressData.forEach(user => {
                const rate = parseInt(user.completionRate) || 0;

                if (rate === 0) {
                    notStartedUsers++;
                } else if (rate === 100) {
                    completedUsers++;
                } else {
                    activeUsers++;
                }

                totalProgress += rate;
            });

            const averageProgress = totalUsers > 0 ?
                Math.round(totalProgress / totalUsers) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('completedUsers').textContent = completedUsers;
            document.getElementById('averageProgress').textContent = averageProgress + '%';
        }

        function updateProgressTable() {
            const tableBody = document.getElementById('progressTableBody');
            const filter = document.getElementById('progressFilter').value;

            let filteredData = allProgressData.filter(user => {
                if (filter === 'all') return true;
                if (filter === 'not-started') return user.completionRate === 0;
                if (filter === 'in-progress') return user.completionRate > 0 && user.completionRate < 100;
                if (filter === 'completed') return user.completionRate === 100;
                return true;
            });

            let html = '';
            filteredData.forEach(user => {
                // completedChaptersListã¯ "lesson1_1,lesson1_2" ã®ã‚ˆã†ãªæ–‡å­—åˆ—
                const completedCount = user.completedChaptersList && user.completedChaptersList.trim() !== '' ?
                    user.completedChaptersList.split(',').filter(c => c.trim() !== '').length : 0;
                const lastUpdated = user.lastUpdated ?
                    new Date(user.lastUpdated).toLocaleDateString('ja-JP') : 'æœªå­¦ç¿’';
                
                let status = 'æœªé–‹å§‹';
                let statusClass = 'not-started';
                
                if (user.completionRate === 100) {
                    status = 'å®Œäº†';
                    statusClass = 'completed';
                } else if (user.completionRate > 0) {
                    status = 'å­¦ç¿’ä¸­';
                    statusClass = 'in-progress';
                }

                html += `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.userName}</td>
                        <td>
                            <div class="progress-cell">
                                <div class="progress-bar small">
                                    <div class="progress-fill" style="width: ${user.completionRate}%"></div>
                                </div>
                                <span>${user.completionRate}%</span>
                            </div>
                        </td>
                        <td>${completedCount} / ${user.totalChapters}</td>
                        <td>${lastUpdated}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-small" onclick="showUserDetail('${user.userId}')">
                                è©³ç´°
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html || '<tr><td colspan="7" class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        }

        function updateHistoryTable() {
            const tableBody = document.getElementById('historyTableBody');
            const filter = document.getElementById('historyFilter').value;
            
            let filteredHistory = allLoginHistory.filter(entry => {
                const loginDate = new Date(entry.loginTime);
                const now = new Date();
                
                if (filter === 'all') return true;
                if (filter === 'today') {
                    return loginDate.toDateString() === now.toDateString();
                }
                if (filter === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return loginDate >= weekAgo;
                }
                if (filter === 'month') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    return loginDate >= monthAgo;
                }
                return true;
            });

            // æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆ
            filteredHistory.sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime));

            let html = '';
            filteredHistory.slice(0, 100).forEach(entry => { // æœ€æ–°100ä»¶ã®ã¿è¡¨ç¤º
                const loginTime = new Date(entry.loginTime).toLocaleString('ja-JP');
                const logoutTime = entry.logoutTime ? 
                    new Date(entry.logoutTime).toLocaleString('ja-JP') : 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­';
                
                let sessionTime = '-';
                let statusClass = 'active';
                let status = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­';

                if (entry.logoutTime) {
                    const duration = new Date(entry.logoutTime) - new Date(entry.loginTime);
                    const minutes = Math.floor(duration / 60000);
                    sessionTime = `${minutes}åˆ†`;
                    status = 'å®Œäº†';
                    statusClass = 'completed';
                }

                html += `
                    <tr>
                        <td>${entry.userId}</td>
                        <td>${entry.name}</td>
                        <td>${loginTime}</td>
                        <td>${logoutTime}</td>
                        <td>${sessionTime}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html || '<tr><td colspan="6" class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        }

        function showUserDetail(userId) {
            const user = allProgressData.find(u => u.userId === userId);
            if (!user) return;

            document.getElementById('modalUserName').textContent = `${user.userName}ã®è©³ç´°æƒ…å ±`;
            document.getElementById('modalUserId').textContent = user.userId;
            document.getElementById('modalProgress').textContent = user.completionRate + '%';
            
            // æœ€æ–°ã®ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã‚’å–å¾—
            const lastLogin = allLoginHistory
                .filter(entry => entry.userId === userId)
                .sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime))[0];
            
            const lastLoginText = lastLogin ? 
                new Date(lastLogin.loginTime).toLocaleString('ja-JP') : 'å±¥æ­´ãªã—';
            document.getElementById('modalLastLogin').textContent = lastLoginText;

            // å®Œäº†ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã®è¡¨ç¤º
            let completedChaptersHtml = '';
            if (user.completedChaptersList && user.completedChaptersList.trim() !== '') {
                const chapters = user.completedChaptersList.split(',').filter(c => c.trim() !== '');
                completedChaptersHtml = chapters.map(chapterId => `
                    <div class="completed-chapter-item">
                        <span class="chapter-title">${chapterId}</span>
                    </div>
                `).join('');
            } else {
                completedChaptersHtml = '<div class="no-data">å®Œäº†ã—ãŸãƒãƒ£ãƒ—ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            }

            document.getElementById('modalCompletedChapters').innerHTML = completedChaptersHtml;
            
            document.getElementById('userDetailModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userDetailModal').style.display = 'none';
        }

        function switchTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'progress') {
                document.getElementById('progressTab').classList.add('active');
            } else if (tabName === 'login-history') {
                document.getElementById('loginHistoryTab').classList.add('active');
            } else if (tabName === 'export') {
                document.getElementById('exportTab').classList.add('active');
            }
        }

        function filterProgress() {
            updateProgressTable();
        }

        function filterHistory() {
            updateHistoryTable();
        }

        function refreshProgress() {
            loadAdminData();
            updateStatistics();
        }

        function refreshHistory() {
            loadAdminData();
        }

        function exportProgressCSV() {
            let csvContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID,ãƒ¦ãƒ¼ã‚¶ãƒ¼å,ç·ãƒãƒ£ãƒ—ã‚¿ãƒ¼æ•°,å®Œäº†ãƒãƒ£ãƒ—ã‚¿ãƒ¼æ•°,é€²æ—ç‡(%),æœ€çµ‚æ›´æ–°æ—¥æ™‚\n';

            allProgressData.forEach(user => {
                const completedCount = user.completedChaptersList ?
                    user.completedChaptersList.split(',').filter(c => c.trim() !== '').length : 0;

                const row = [
                    user.userId,
                    user.userName,
                    user.totalChapters,
                    completedCount,
                    user.completionRate,
                    user.lastUpdated || ''
                ].join(',');

                csvContent += row + '\n';
            });

            downloadCSV(csvContent, 'progress_data.csv');
        }

        function exportHistoryCSV() {
            let csvContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID,ãƒ¦ãƒ¼ã‚¶ãƒ¼å,ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚,ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ—¥æ™‚,ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“(åˆ†)\n';
            
            allLoginHistory.forEach(entry => {
                const sessionMinutes = entry.logoutTime ? 
                    Math.floor((new Date(entry.logoutTime) - new Date(entry.loginTime)) / 60000) : '';
                
                const row = [
                    entry.userId,
                    entry.name,
                    new Date(entry.loginTime).toLocaleString('ja-JP'),
                    entry.logoutTime ? new Date(entry.logoutTime).toLocaleString('ja-JP') : '',
                    sessionMinutes
                ].join(',');
                
                csvContent += row + '\n';
            });

            downloadCSV(csvContent, 'login_history.csv');
        }

        function exportStatisticsReport() {
            const report = generateStatisticsReport();
            downloadCSV(report, 'statistics_report.csv');
        }

        function generateStatisticsReport() {
            let report = 'å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ\n';
            report += `ç”Ÿæˆæ—¥æ™‚,${new Date().toLocaleString('ja-JP')}\n\n`;
            
            report += 'åŸºæœ¬çµ±è¨ˆ\n';
            report += `ç·å—è¬›è€…æ•°,${document.getElementById('totalUsers').textContent}\n`;
            report += `å­¦ç¿’ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼,${document.getElementById('activeUsers').textContent}\n`;
            report += `å®Œäº†ãƒ¦ãƒ¼ã‚¶ãƒ¼,${document.getElementById('completedUsers').textContent}\n`;
            report += `å¹³å‡é€²æ—ç‡,${document.getElementById('averageProgress').textContent}\n\n`;
            
            report += 'é€²æ—ç‡åˆ†å¸ƒ\n';
            const distribution = [0, 25, 50, 75, 100].map(threshold => {
                const count = allProgressData.filter(user => user.completionRate >= threshold).length;
                return `${threshold}%ä»¥ä¸Š,${count}äºº`;
            }).join('\n');
            
            report += distribution + '\n\n';
            
            report += 'æœ€æ–°ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´(ä¸Šä½10ä»¶)\n';
            report += 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID,ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚\n';
            
            allLoginHistory
                .sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime))
                .slice(0, 10)
                .forEach(entry => {
                    report += `${entry.userId},${new Date(entry.loginTime).toLocaleString('ja-JP')}\n`;
                });
            
            return report;
        }

        function downloadCSV(csvContent, filename) {
            const bom = '\uFEFF'; // UTF-8 BOM
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('userDetailModal');
            if (event.target === modal) {
                closeUserModal();
            }
        }
    </script>
</body>
</html>