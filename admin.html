<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学習管理システム - 管理者画面</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin-styles.css">
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="logo"></div>
        <div class="user-info">
            <span class="user-name" id="userName">管理者</span>
            <button class="logout-btn" onclick="authSystem.logout()">ログアウト</button>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="admin-container">
            <!-- ページタイトル -->
            <div class="page-header">
                <h1 class="page-title">管理者画面</h1>
                <p class="page-description">受講者の学習進捗とシステム利用状況を管理できます。</p>
            </div>

            <!-- 統計サマリー -->
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">👥</div>
                        <div class="stat-content">
                            <h3>総受講者数</h3>
                            <div class="stat-number" id="totalUsers">30</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📚</div>
                        <div class="stat-content">
                            <h3>学習中ユーザー</h3>
                            <div class="stat-number" id="activeUsers">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <h3>完了ユーザー</h3>
                            <div class="stat-number" id="completedUsers">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <h3>平均進捗率</h3>
                            <div class="stat-number" id="averageProgress">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- タブナビゲーション -->
            <div class="admin-tabs">
                <button class="tab-button active" onclick="switchTab('progress')">進捗管理</button>
            </div>

            <!-- 進捗管理タブ -->
            <div class="tab-content active" id="progressTab">
                <div class="section-header">
                    <h2>受講者進捗一覧</h2>
                    <div class="controls">
                        <select id="progressFilter" onchange="filterProgress()">
                            <option value="all">すべて</option>
                            <option value="not-started">未開始</option>
                            <option value="in-progress">学習中</option>
                            <option value="completed">完了</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshProgress()">🔄 更新</button>
                    </div>
                </div>

                <div class="progress-table-container">
                    <table class="admin-table" id="progressTable">
                        <thead>
                            <tr>
                                <th>ユーザーID</th>
                                <th>ユーザー名</th>
                                <th>進捗率</th>
                                <th>完了チャプター</th>
                                <th>最終更新</th>
                                <th>ステータス</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                            <!-- JavaScriptで動的に生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 受講者詳細モーダル -->
            <div class="modal" id="userDetailModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalUserName">ユーザー詳細</h3>
                        <button class="modal-close" onclick="closeUserModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="user-detail-grid">
                            <div class="detail-section">
                                <h4>基本情報</h4>
                                <div class="detail-item">
                                    <span class="label">ユーザーID:</span>
                                    <span class="value" id="modalUserId">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">進捗率:</span>
                                    <span class="value" id="modalProgress">-</span>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h4>完了チャプター</h4>
                                <div class="completed-chapters" id="modalCompletedChapters">
                                    <!-- 動的に生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeUserModal()">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScriptファイル -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/hybrid-progress.js"></script>
    <script>
        let allProgressData = [];

        document.addEventListener('DOMContentLoaded', function() {
            // 管理者権限チェック
            if (!authSystem.requireAdmin()) {
                return;
            }

            // ログインユーザー情報を表示
            const currentUser = authSystem.getCurrentUser();
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || '管理者';
            }

            // データの初期読み込み
            loadAdminData();

            // 統計の表示
            updateStatistics();
        });

        async function loadAdminData() {
            try {
                // Google Sheetsから進捗データを取得
                console.log('📊 Google Sheetsから進捗データを取得中...');
                const sheetsData = await hybridProgressManager.fetchFromGoogleSheetsAPI();

                // Usersシートからrole情報を取得
                const usersUrl = `${CONFIG.GOOGLE_SHEETS_API_BASE_URL}/${CONFIG.SPREADSHEET_ID}/values/Users!A:E?key=${CONFIG.GOOGLE_API_KEY}`;
                const usersResponse = await fetch(usersUrl);
                const usersData = await usersResponse.json();

                // ユーザーロールのマップを作成（userId -> role）
                const userRoles = {};
                if (usersData && usersData.values && usersData.values.length > 1) {
                    usersData.values.slice(1).forEach(row => {
                        const userId = row[0];
                        const role = row[2]; // C列がrole
                        if (userId) {
                            userRoles[userId] = role;
                        }
                    });
                }

                if (sheetsData && sheetsData.values && sheetsData.values.length > 1) {
                    // ヘッダー行をスキップして変換
                    allProgressData = sheetsData.values.slice(1).map(row => {
                        return {
                            userId: row[0] || '',
                            userName: row[1] || '',
                            totalChapters: parseInt(row[2]) || 34,
                            completedChapters: [],
                            completionRate: parseInt(row[4]) || 0,
                            lastUpdated: row[5] || '',
                            completedChaptersList: row[6] || ''
                        };
                    }).filter(user => {
                        // 空行を除外、かつ管理者(admin)を除外
                        return user.userId && userRoles[user.userId] !== 'admin';
                    });

                    console.log(`✅ ${allProgressData.length}件の進捗データを取得しました（管理者除外）`);
                } else {
                    console.log('⚠️  進捗データが見つかりません');
                    allProgressData = [];
                }

                // テーブルの更新
                updateProgressTable();
                updateStatistics();

            } catch (error) {
                console.error('❌ Google Sheetsからの同期エラー:', error);
                alert('進捗データの読み込みに失敗しました。ネットワーク接続を確認してください。');
                allProgressData = [];
            }
        }

        function updateStatistics() {
            // 実際のデータから総受講者数を計算
            const totalUsers = allProgressData.length;
            let activeUsers = 0;
            let completedUsers = 0;
            let notStartedUsers = 0;
            let totalProgress = 0;

            allProgressData.forEach(user => {
                const rate = parseInt(user.completionRate) || 0;

                if (rate === 0) {
                    notStartedUsers++;
                } else if (rate === 100) {
                    completedUsers++;
                } else {
                    activeUsers++;
                }

                totalProgress += rate;
            });

            const averageProgress = totalUsers > 0 ?
                Math.round(totalProgress / totalUsers) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('completedUsers').textContent = completedUsers;
            document.getElementById('averageProgress').textContent = averageProgress + '%';
        }

        function updateProgressTable() {
            const tableBody = document.getElementById('progressTableBody');
            const filter = document.getElementById('progressFilter').value;

            let filteredData = allProgressData.filter(user => {
                if (filter === 'all') return true;
                if (filter === 'not-started') return user.completionRate === 0;
                if (filter === 'in-progress') return user.completionRate > 0 && user.completionRate < 100;
                if (filter === 'completed') return user.completionRate === 100;
                return true;
            });

            let html = '';
            filteredData.forEach(user => {
                // completedChaptersListは "lesson1_1,lesson1_2" のような文字列
                const completedCount = user.completedChaptersList && user.completedChaptersList.trim() !== '' ?
                    user.completedChaptersList.split(',').filter(c => c.trim() !== '').length : 0;
                const lastUpdated = user.lastUpdated ?
                    new Date(user.lastUpdated).toLocaleDateString('ja-JP') : '未学習';
                
                let status = '未開始';
                let statusClass = 'not-started';
                
                if (user.completionRate === 100) {
                    status = '完了';
                    statusClass = 'completed';
                } else if (user.completionRate > 0) {
                    status = '学習中';
                    statusClass = 'in-progress';
                }

                html += `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.userName}</td>
                        <td>
                            <div class="progress-cell">
                                <div class="progress-bar small">
                                    <div class="progress-fill" style="width: ${user.completionRate}%"></div>
                                </div>
                                <span>${user.completionRate}%</span>
                            </div>
                        </td>
                        <td>${completedCount} / ${user.totalChapters}</td>
                        <td>${lastUpdated}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-small" onclick="showUserDetail('${user.userId}')">
                                詳細
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html || '<tr><td colspan="7" class="no-data">データがありません</td></tr>';
        }


        function showUserDetail(userId) {
            const user = allProgressData.find(u => u.userId === userId);
            if (!user) return;

            document.getElementById('modalUserName').textContent = `${user.userName}の詳細情報`;
            document.getElementById('modalUserId').textContent = user.userId;
            document.getElementById('modalProgress').textContent = user.completionRate + '%';

            // 完了チャプターの表示
            let completedChaptersHtml = '';
            if (user.completedChaptersList && user.completedChaptersList.trim() !== '') {
                const chapters = user.completedChaptersList.split(',').filter(c => c.trim() !== '');
                completedChaptersHtml = chapters.map(chapterId => `
                    <div class="completed-chapter-item">
                        <span class="chapter-title">${chapterId}</span>
                    </div>
                `).join('');
            } else {
                completedChaptersHtml = '<div class="no-data">完了したチャプターがありません</div>';
            }

            document.getElementById('modalCompletedChapters').innerHTML = completedChaptersHtml;
            
            document.getElementById('userDetailModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userDetailModal').style.display = 'none';
        }

        function switchTab(tabName) {
            // タブが1つしかないので何もしない（後方互換性のため関数は残す）
        }

        function filterProgress() {
            updateProgressTable();
        }

        function refreshProgress() {
            loadAdminData();
            updateStatistics();
        }

        // モーダル外クリックで閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('userDetailModal');
            if (event.target === modal) {
                closeUserModal();
            }
        }
    </script>
</body>
</html>